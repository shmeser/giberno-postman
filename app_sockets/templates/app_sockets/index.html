{% extends "app_sockets/base.html" %}

{% block title %}Sockets{% endblock %}
{% block header_text %}Sockets{% endblock %}

{% block content %}
    <div class="sockets-container">

        <div class="creds-container mb-10">
            <label for="jwt-token">
                JWT
            </label>
            <div class="flex flex-row w-100 jc-around">
                <input
                        placeholder="JWT Token (сохраняется в LocalStorage при успешном соединении)"
                        id="jwt-token" type="text"
                />
                <button class="clear-jwt" id="clear-jwt" onclick="clearJWT()">✖</button>
            </div>
            <label for="sockets-route">
                SOCKET ROUTE
            </label>
            <div class="routes-block">
                <input
                        placeholder="/v1.0/sockets или /v1.0/sockets/chats/1"
                        value=""
                        id="sockets-route" type="text" required="required"
                />
                <button class="clear-route" id="clear-route" onclick="clearRoute()">✖</button>
                <button type="button" id="connect-button">Add Connection</button>
            </div>
        </div>

        <div class="connections-container-scroll">
            <div class="connections-container" id="connections"></div>
        </div>

    </div>

{% endblock %}


{% block extra_body %}
    <script>
        let protocol = 'ws://';
        protocol = '{{ ws_protocol }}';

        const _EVENT_TYPES = {
            'LEAVE_TOPIC': 0,
            'JOIN_TOPIC': 1,
            'NEW_MESSAGE_TO_CHAT': 2,
            'READ_MESSAGE_IN_CHAT': 3,
            'NEW_COMMENT_TO_VACANCY': 4,
            'LOCATION': 10,
            'SERVER_SYSTEM_MESSAGE': 100,
            'SERVER_PROFILE_UPDATED': 101,
            'SERVER_NEW_MESSAGE_IN_CHAT': 102,
            'SERVER_MESSAGE_IN_CHAT_UPDATED': 103,
            'SERVER_CHAT_UPDATED': 104,
            'NOTIFICATION': 200,
            'TOPIC_LEAVED': 300,
            'TOPIC_JOINED': 301,
            'ERROR': 400
        };

        let socket;

        let socketConnections = []; // Массив подключенных сокетов


        const clearJWT = () => {
            document.getElementById('jwt-token').value = '';
            document.getElementById('clear-jwt').blur();
            localStorage.removeItem('socket-jwt');
        };

        const getJWT = () => {
            document.getElementById('jwt-token').value = localStorage.getItem('socket-jwt');
        };

        const setJWT = () => {
            const jwt = document.getElementById('jwt-token').value;
            localStorage.setItem('socket-jwt', jwt);
        };

        const clearRoute = () => {
            document.getElementById('sockets-route').value = '';
            document.getElementById('clear-route').blur();
            localStorage.removeItem('sockets-route');
        };

        const getRoute = () => {
            document.getElementById('sockets-route').value = localStorage.getItem('sockets-route');
        };

        const setRoute = () => {
            const jwt = document.getElementById('sockets-route').value;
            localStorage.setItem('sockets-route', jwt);
        };

        const disconnect = (connectionId) => {
            const connection = socketConnections.find(e => e.id === connectionId); // Ищем нужное соединение

            if (connection) {
                connection.socket.close(); // Закрываем соединение
                removeClosedConnection(connectionId); // Удаляем закрытое соединение
            } else {
                $('#connections').find(`#${connectionId}`).remove(); // Удаляем из DOM блок соединения
            }
        };

        const removeClosedConnection = (connectionId) => {
            socketConnections = socketConnections.filter(e => e.id !== connectionId);
        };

        const sendMessage = (connectionId) => {
            let data = JSON.stringify(
                JSON.parse( // Парсим полученную JSON-строку из поля ввода тела сообщения
                    document.getElementById(`message-${connectionId}`).value
                )
                , undefined, 4 // Форматируем красиво
            );

            sendEvent(connectionId, data); // Отправляем

        };

        const disableConnectionBlock = (connectionId) => {
            // Отключение кнопок при отсоединении от сокетов
            let connectionBlock = document.getElementById(`${connectionId}`);
            let disconnectButton = document.getElementById(`disconnect-${connectionId}`);

            let button = document.getElementById(`action-${connectionId}`);
            button.setAttribute('disabled', 'disabled');

            disconnectButton.value = 'Remove Block';
            connectionBlock.classList.add('closed')
        };

        const addMessageToHistory = (id, data, className = 'system') => {
            let messagesHistoryEl = document.getElementById(`messages-history-${id}`); // Блок истории сообщений

            // Создаем элемент с данными сообщения
            let messageHTML = document.createElement('pre');
            messageHTML.className = className;
            messageHTML.innerHTML = data;
            // Создаем элемент для времени и даты
            let messageDateTime = document.createElement('p');
            messageDateTime.appendChild(document.createTextNode((new Date()).toISOString()));
            messageDateTime.className = 'message-datetime';
            // Создаем блок-контейнер для сообщения
            let messageBlock = document.createElement('div');
            messageBlock.className = 'message-block';

            messageBlock.appendChild(messageDateTime);
            messageBlock.appendChild(messageHTML);

            messagesHistoryEl.prepend(messageBlock); // Добавляем блок в историю
        };

        const sendEvent = (connectionId, data) => {
            addMessageToHistory(connectionId, data, 'outcomming'); // Добавляем в блок истории

            const connection = socketConnections.find(e => e.id === connectionId); // Ищем нужное соединение
            connection.socket.send(data) // Отправляем данные
        };


        const formatMessage = (connectionId, eventType) => {
            let messageBody = document.getElementById(`message-${connectionId}`);

            //eventType из енума SocketEventType
            if (eventType === _EVENT_TYPES.JOIN_TOPIC) {
                messageBody.value = JSON.stringify({
                    "eventType": eventType,
                    "topic": 'chats1'
                }, undefined, 4);
            }
            if (eventType === _EVENT_TYPES.LEAVE_TOPIC) {
                messageBody.value = JSON.stringify({
                    "eventType": eventType,
                    "topic": 'vacancies2'
                }, undefined, 4);
            }

            if (eventType === _EVENT_TYPES.LOCATION) {
                messageBody.value = JSON.stringify({
                    "eventType": eventType,
                    "lat": 55,
                    "lon": 37,
                }, undefined, 4);
            }

            if (eventType === _EVENT_TYPES.NEW_MESSAGE_TO_CHAT) {
                messageBody.value = JSON.stringify({
                    "eventType": eventType,
                    "messageType": 1,
                    "chatId": 1,
                    "text": "тестовое сообщение",
                    "attachments": [
                        '73f39c0e-9e5f-4f26-a15f-5eb7f6547b36',
                        'a2f2dce9-0e7e-4947-a0a3-775e74a97daa',
                        '4ad0c744-b8d0-4bcf-8705-e0930641fdeb'
                    ],
                    "commandData": {
                        "acceptDocs": [
                            '73f39c0e-9e5f-4f26-a15f-5eb7f6547b36',
                            'a2f2dce9-0e7e-4947-a0a3-775e74a97daa',
                            '4ad0c744-b8d0-4bcf-8705-e0930641fdeb'
                        ]
                    }
                }, undefined, 4);
            }

        };


        const addConnectionBlock = (connectionId, jwt, route) => {
            $('#connections').prepend(
                `<div class="connection mb-10 mr-10" id="${connectionId}">
                    <div class="dashboard">
                        <div class="connection-status mb-10 pb-10">
                            <div class="jwt">${jwt}</div>
                            <label class="connection-route" for="disconnect-button">${route}</label>
                            <input id="disconnect-${connectionId}" type="button" class="connection-button disconnect-button" value="Disconnect" onclick="disconnect(${connectionId});">
                        </div>
                        <div class="event-options mb-10">
                            <button class="message-type-button" onclick="formatMessage(${connectionId}, ${_EVENT_TYPES.JOIN_TOPIC})">Join Topic</button>
                            <button class="message-type-button" onclick="formatMessage(${connectionId}, ${_EVENT_TYPES.LEAVE_TOPIC})">Leave Topic</button>
                            <button class="message-type-button" onclick="formatMessage(${connectionId}, ${_EVENT_TYPES.LOCATION})">Location</button>
                            <button class="message-type-button" onclick="formatMessage(${connectionId}, ${_EVENT_TYPES.NEW_MESSAGE_TO_CHAT})">Message</button>
                        </div>
                        <textarea rows="10" id="message-${connectionId}"/>
                        <button class="action-button connection-button" id="action-${connectionId}" onclick=sendMessage(${connectionId})>Send Data</button>
                    </div>
                    <div class="messages" id="messages-history-${connectionId}"></div>
                </div>`
            )
        };


        document.getElementById('connect-button').onclick = () => {
            let id = Date.now();
            let socket = new WebSocket(
                protocol + window.location.host +
                document.getElementById('sockets-route').value +
                '?jwt=' + document.getElementById('jwt-token').value
            );

            socket.onopen = (event) => {
                setJWT(); // Сохраняем JWT при успешном соединении
                setRoute(); // Сохраняем route при успешном соединении
                console.log('Connected to socket', event);
            };
            socket.onclose = (event) => {
                let data = JSON.stringify({
                    "connection": id,
                    "type": event.type,
                    "code": event.code,
                }, undefined, 4);

                addMessageToHistory(id, data, 'system');

                disableConnectionBlock(id);
                removeClosedConnection(id);

                console.log('Disconnected from socket', event);
            };

            socket.onerror = (error) => {
                let data = JSON.stringify({
                    "connection": id,
                    "error": error,
                }, undefined, 4);

                addMessageToHistory(id, data, 'error');
                console.log('Socket error', error);
            };

            socket.onmessage = function (message) {
                let data = JSON.parse(message.data);
                // Handle errors
                if (data.error) {
                    console.log(data.error);
                }

                data = JSON.stringify(data, undefined, 4);

                addMessageToHistory(id, data, 'incomming');
            };

            socketConnections.push(
                {
                    id: id,
                    socket: socket
                }
            );

            addConnectionBlock(
                id,
                document.getElementById('jwt-token').value,
                document.getElementById('sockets-route').value
            );
            return false;
        };

        document.addEventListener('DOMContentLoaded', () => {
            getJWT();
            getRoute();
        });
    </script>
{% endblock %}