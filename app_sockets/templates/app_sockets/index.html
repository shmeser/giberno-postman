{% extends "app_sockets/base.html" %}

{% block title %}Sockets{% endblock %}
{% block header_text %}Sockets{% endblock %}

{% block content %}

    <ul class="rooms">
        {% for room in rooms %}
            <li class="room-link" data-room-id="{{ room.id }}">{{ room.title }}</li>
        {% empty %}
            <p class="empty">
                <a href="{% url 'admin:index' %}">Панель администратора</a>
            </p>
        {% endfor %}
    </ul>

    <input type="button" value="connect" id="connect-button">
    <br>
    <input placeholder="Token" id="token-text" type="text" required="required" style="margin-top: 15px; width: 300px"/>
    <br>
    <input type='number' step='0.000001' placeholder='lon' id='lon'>
    <input type='number' step='0.000001' placeholder='lat' id='lat'>
    <button id="send-location">Send Location</button>
    <br>
    <input placeholder="ID" id="elem-id" type="number" min="1" style="margin-top: 15px; width: 300px"/>
    <input id="register-profile-button" type="button" style="margin-top: 15px" value="register profile"/>
    <br>

    <br>
    <input type="button" value="disconnect" id="disconnect-button">

    <div id="chats">
    </div>

{% endblock %}


{% block extra_body %}
    <script>
        let protocol = 'ws://';

        protocol = '{{ ws_protocol }}';

        let socket = new WebSocket(
            protocol + window.location.host + '/sockets/chats/123?jwt=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ0.eyJ0b2tlbl90eXBlIjoiYWNjZXNzIiwiZXhwIjoxNjE0ODQzOTQwLCJqdGkiOiIyNTBhOGUzODEwMDk0M2FhYjljMzhlZTgwYzIwM2JhNCIsInVzZXJfaWQiOjEzfQ.9un2Wc3eb29oOuytK_AeD9foaviAEIyqMz5HJQojQp4',
        );

        let room_id = 0;

        socket.onopen = () => {
            console.log('Connected to chat socket');
        };
        socket.onclose = () => {
            console.log('Disconnected from chat socket');
        };
        document.getElementById('disconnect-button').onclick = () => {
            socket.close();
        };
        document.getElementById('connect-button').onclick = () => {
            socket = new WebSocket(
                protocol + window.location.host +
                '/sockets');
        };
        // Hook up send button to send a message
        document.getElementById('send-location').onclick = () => {
            socket.send(JSON.stringify({
                "eventType": 1,
                "lat": document.getElementById('lat').value,
                "lon": document.getElementById('lon').value,
                "token": document.getElementById('token-text').value
            }));
        };

        socket.onmessage = function (message) {
            // Decode the JSON
            var data = JSON.parse(message.data);
            console.log(data);
            // Handle errors
            if (data.error) {
                console.log(data.error);
                return;
            }
            console.log(data.room);
            room_id = data.room;
            console.log(room_id);
            // Handle joining
            if (data.join) {
                console.log("Joining room " + data.join);
                var roomdiv = $(
                    "<div class='room' id='room-" + data.join + "'>" +
                    "<h2>" + data.title + "</h2>" +
                    "<div class='messages'></div>" +
                    "<button id='leave-button'>Leave group</button>" +
                    "</div>"
                );
                roomdiv.find("#leave-button").on('click', () => {
                    socket.send(JSON.stringify({
                        "eventType": 0,
                        "token": document.getElementById('token-text').value,
                        "groupName": data.join
                    }));
                });
                roomdiv.find("#start-button").on('click', () => {
                    socket.send(JSON.stringify({
                        "eventType": 1007,
                        "roomId": room_id,
                        "message": roomdiv.find("input").val()
                    }));
                });

                $("#chats").append(roomdiv);
                // Handle leaving
            } else if (data.leave) {
                console.log("Leaving room " + data.leave);
                $("#room-" + data.leave).remove();
                // Handle getting a message
            } else if (data.data.text || data.eventType !== 0) {
                var msgdiv = $("#room-" + data.data.chatId + " .messages");
                var ok_msg = "";
                // msg types are defined in chat/settings.py
                // Only for demo purposes is hardcoded, in production scenarios, consider call a service.
                switch (data.eventType) {
                    case 101:
                        // Message
                        ok_msg = "<div class='message'>" +
                            "<span class='username'>" + data.data.chatId + "</span><br>" +
                            "<span class='body'>" + data.data.text + "</span>" +
                            "</div>";

                        break;
                    case 2:
                        // Warning / Advice messages
                        ok_msg = "<div class='contextual-message text-warning'>" + data.message +
                            "</div>";
                        break;
                    case 3:
                        // Alert / Danger messages
                        ok_msg = "<div class='contextual-message text-danger'>" + data.message +
                            "</div>";
                        break;
                    case 4:
                        // "Muted" messages
                        ok_msg = "<div class='contextual-message text-muted'>" + data.message +
                            "</div>";
                        break;
                    case 5:
                        // User joined room
                        ok_msg = "<div class='contextual-message text-muted'>" + data.message +
                            "</div>";
                        break;
                    case 6:
                        // User left room
                        ok_msg = "<div class='contextual-message text-muted'>" + data.message +
                            "</div>";
                        break;
                    default:
                        console.log("Unsupported message type!");
                        return;
                }
                msgdiv.append(ok_msg);
                msgdiv.scrollTop(msgdiv.prop("scrollHeight"));
            } else {
                console.log("Cannot handle message!");
            }
        };
        // Says if we joined a room or not by if there's a div for it
        inRoom = function (roomId) {
            return $("#room-" + roomId).length > 0;
        };
        // Room join/leave
        document.getElementById('register-profile-button').onclick = () => {
            socket.send(JSON.stringify({
                'eventType': 2,
                'token': document.getElementById('token-text').value,
                'profileId': document.getElementById('elem-id').value
            }));
        };
    </script>
{% endblock %}